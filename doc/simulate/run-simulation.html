
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <script src="https://unpkg.com/lucide@latest"></script>
  
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>How to run a simulation &#8212; OpenFisca  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/guzzle.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Analysing or debugging a simulation" href="analyse-simulation.html" />
    <link rel="prev" title="Running a simulation" href="index.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="analyse-simulation.html" title="Analysing or debugging a simulation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Running a simulation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../summary.html">OpenFisca  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><i icon-name="cog"></i> Running a simulation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to run a simulation</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><div class="sphinxsidebar-logo">
    <a href="/">
        <svg class="logo" viewBox="0 0 257 210" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M0.763527 104.891L0.744415 104.872L59.5103 46.106L75.7266 62.3222L33.1545 104.894L75.7233 147.463L59.5071 163.679L0.741158 104.913L0.763527 104.891Z" fill="#C42323"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M122.255 50.865C115.622 45.6901 114.267 36.1127 119.469 29.4458C124.607 22.8599 134.057 21.7898 140.68 26.7535L150.012 34.0353L166.259 17.7541L154.623 8.54467L154.614 8.55564C137.925 -4.12702 114.359 -1.47913 101.424 14.5007L100.584 15.5772C88.1288 32.1439 91.4448 55.8966 108.156 68.9351L108.158 68.9369L108.161 68.9333L110.162 70.5372C96.4602 77.9788 87.999 93.2683 90.025 109.681C91.4666 121.358 97.9197 131.193 106.962 137.296L106.961 137.296L135.367 158.906L135.357 158.918L135.36 158.92C141.992 164.095 143.347 173.672 138.146 180.339C133.007 186.925 123.557 187.995 116.935 183.032L107.602 175.75L91.3556 192.031L102.992 201.24L103 201.23C119.689 213.912 143.255 211.264 156.19 195.284L157.03 194.208C169.486 177.641 166.17 153.889 149.459 140.85L149.456 140.848L149.454 140.852L147.453 139.248C161.154 131.806 169.614 116.517 167.589 100.106C166.147 88.4274 159.693 78.5918 150.65 72.4893L150.653 72.4895L122.247 50.8791L122.257 50.8668L122.255 50.865ZM130.704 120.26C139.313 119.197 145.293 111.395 144.255 102.986C143.217 94.5768 135.519 88.4635 126.91 89.5262C118.301 90.589 112.321 98.3907 113.359 106.8C114.397 115.209 122.095 121.323 130.704 120.26Z" fill="#C42323"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M256.85 104.891L256.869 104.872L198.103 46.106L181.887 62.3222L224.459 104.894L181.89 147.463L198.106 163.679L256.872 104.913L256.85 104.891Z" fill="#C42323"/>
        </svg>
        <span>OpenFisca Documentation</span>
    </a>
</div>

<div class="sphinxsidebar-search">
    
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
</div>

<div class="sphinxsidebar-toc">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html"><i icon-name="home"></i> Before you start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html"><i icon-name="boxes"></i> Architecture of OpenFisca</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html"><i icon-name="download"></i> Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key-concepts/index.html"><i icon-name="lightbulb"></i> Key concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coding-the-legislation/index.html"><i icon-name="terminal"></i> From law to code</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html"><i icon-name="cog"></i> Running a simulation</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to run a simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="analyse-simulation.html">Analysing or debugging a simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="replicate-simulation-inputs.html">Replicating a situation along axes</a></li>
<li class="toctree-l2"><a class="reference internal" href="profile-simulation.html">How to profile the performance of a simulation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../openfisca-python-api/index.html"><i icon-name="function-square"></i> OpenFisca Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openfisca-web-api/index.html"><i icon-name="curly-braces"></i> OpenFisca web API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../find-help.html"><i icon-name="heart-handshake"></i> To find help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html"><i icon-name="git-merge"></i> Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html"><i icon-name="copyleft"></i> License</a></li>
</ul>

</div>

      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../summary.html">Docs</a></li>
              
                <li><a href="index.html"><i icon-name="cog"></i> Running a simulation</a></li>
              
              <li>How to run a simulation</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <section id="how-to-run-a-simulation">
<h1>How to run a simulation<a class="headerlink" href="#how-to-run-a-simulation" title="Permalink to this headline">¶</a></h1>
<p>To calculate some legislation variables on people’s situations, you need to create and run a new <em>Simulation</em>. Whether situations are described with <a class="reference internal" href="#test-cases"><span class="std std-doc">test cases</span></a> or <a class="reference internal" href="#data"><span class="std std-doc">data</span></a>, OpenFisca looks for two kinds of inputs:</p>
<ul class="simple">
<li><p>how persons are dispatched in other entities,</p></li>
<li><p>what variables’ values are already known.</p></li>
</ul>
<section id="how-to-run-a-simulation-on-a-test-case">
<h2>How to run a simulation on a test case<a class="headerlink" href="#how-to-run-a-simulation-on-a-test-case" title="Permalink to this headline">¶</a></h2>
<p>Test cases can be expressed in Python, or in JSON when using the web API (see the <a class="reference internal" href="../openfisca-web-api/input-output-data.html"><span class="doc std std-doc">specific section</span></a> of the documentation).</p>
<section id="test-cases">
<h3>Test cases<a class="headerlink" href="#test-cases" title="Permalink to this headline">¶</a></h3>
<p>A test case describes persons and other entities with their variables values.
It’s the usual solution to define a small number of situations.</p>
<p>Here is an example of test case (in Python):</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">BASIC_TEST_CASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;persons&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Ari&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;Paul&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;Leila&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;Javier&#39;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="s1">&#39;households&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Leila&#39;</span><span class="p">],</span> <span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ari&#39;</span><span class="p">,</span> <span class="s1">&#39;Paul&#39;</span><span class="p">]},</span>
        <span class="s1">&#39;h2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Javier&#39;</span><span class="p">]}</span>
        <span class="p">},</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>This test case defines 4 persons, <code class="docutils literal notranslate"><span class="pre">Ari</span></code>, <code class="docutils literal notranslate"><span class="pre">Paul</span></code>, <code class="docutils literal notranslate"><span class="pre">Leila</span></code> and <code class="docutils literal notranslate"><span class="pre">Javier</span></code>.
They belong to 2 households named <code class="docutils literal notranslate"><span class="pre">h1</span></code> and <code class="docutils literal notranslate"><span class="pre">h2</span></code>.
For example, <code class="docutils literal notranslate"><span class="pre">Ari</span></code> and <code class="docutils literal notranslate"><span class="pre">Paul</span></code> are parents in <code class="docutils literal notranslate"><span class="pre">h1</span></code> and have one child, <code class="docutils literal notranslate"><span class="pre">Leila</span></code>.</p>
<p>You may add information at the <em>individual</em> level or at the <em>group entity</em> level:</p>
<ul class="simple">
<li><p>known variable values,</p></li>
<li><p>and definition periods for those variable values.</p></li>
</ul>
<p>Let’s say that we want to add a salary to <code class="docutils literal notranslate"><span class="pre">Ari</span></code> and a <code class="docutils literal notranslate"><span class="pre">rent</span></code> to <code class="docutils literal notranslate"><span class="pre">h1</span></code>.
Here is the updated test case:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_CASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;persons&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Ari&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;salary&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;2011-01&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;Paul&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;Leila&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;Javier&#39;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="s1">&#39;households&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Leila&#39;</span><span class="p">],</span>
            <span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ari&#39;</span><span class="p">,</span> <span class="s1">&#39;Paul&#39;</span><span class="p">],</span>
            <span class="s1">&#39;rent&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;2011-01&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;h2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Javier&#39;</span><span class="p">]}</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">salary</span></code> and <code class="docutils literal notranslate"><span class="pre">rent</span></code> names come from the <a class="reference external" href="https://demo.openfisca.org/legislation/salary">salary</a> and <a class="reference external" href="https://demo.openfisca.org/legislation/rent">rent</a> variables of the <code class="docutils literal notranslate"><span class="pre">OpenFisca-Country-Template</span></code>. In this <a class="reference external" href="https://demo.openfisca.org/legislation/">model</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">salary</span></code> is a Person entity variable defined on a monthly basis,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rent</span></code> is a Household entity variable defined on a monthly basis as well.</p></li>
</ul>
<p>It’s a Python dictionary object that we will use to build a <em>Simulation</em>.</p>
<section id="application-calculate-two-households-housing-allowances">
<h4>Application: calculate two households housing allowances<a class="headerlink" href="#application-calculate-two-households-housing-allowances" title="Permalink to this headline">¶</a></h4>
<p>Let’s assume that you want to calculate households’ <code class="docutils literal notranslate"><span class="pre">housing_allowance</span></code> for the same period.
You have to follow these steps:</p>
<ol class="arabic simple">
<li><p>Load a tax and benefit system like <a class="reference external" href="https://demo.openfisca.org/legislation">OpenFisca-Country-Template</a>.</p></li>
<li><p>Initialise a <em>SimulationBuilder</em>.</p></li>
<li><p>Create a <em>Simulation</em> using, for example, the <code class="docutils literal notranslate"><span class="pre">build_from_entities(...)</span></code> function.</p></li>
<li><p>Calculate the <a class="reference external" href="https://demo.openfisca.org/legislation/housing_allowance">housing_allowance</a> and print its value for every test case household.</p></li>
</ol>
<p>Which gives:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">openfisca_core.simulation_builder</span> <span class="kn">import</span> <span class="n">SimulationBuilder</span>
<span class="kn">from</span> <span class="nn">openfisca_country_template</span> <span class="kn">import</span> <span class="n">CountryTaxBenefitSystem</span>


<span class="n">TEST_CASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># ... whole test case ...</span>
<span class="p">}</span>

<span class="n">tax_benefit_system</span> <span class="o">=</span> <span class="n">CountryTaxBenefitSystem</span><span class="p">()</span>

<span class="n">simulation_builder</span> <span class="o">=</span> <span class="n">SimulationBuilder</span><span class="p">()</span>
<span class="n">simulation</span> <span class="o">=</span> <span class="n">simulation_builder</span><span class="o">.</span><span class="n">build_from_entities</span><span class="p">(</span><span class="n">tax_benefit_system</span><span class="p">,</span> <span class="n">TEST_CASE</span><span class="p">)</span>

<span class="n">housing_allowance</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s1">&#39;housing_allowance&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-01&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;households&quot;</span><span class="p">,</span> <span class="n">simulation</span><span class="o">.</span><span class="n">household</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;housing_allowance&quot;</span><span class="p">,</span> <span class="n">housing_allowance</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="how-to-run-a-simulation-on-data">
<h2>How to run a simulation on data<a class="headerlink" href="#how-to-run-a-simulation-on-data" title="Permalink to this headline">¶</a></h2>
<p>You can build a <em>Simulation</em> on multiple data formats.
Any well structured tabular input shoud be fine as long as you are able to iterate over its items in Python.</p>
<section id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h3>
<p>Data sets describe multiple people situations. It could define a whole population.
This data could come from a survey with aggregated data, data files extracted from a database, etc.</p>
<blockquote>
<div><p>Here is a <a class="reference external" href="https://www.casd.eu/en/source/tax-and-social-incomes-survey/">survey example</a>. It typically goes from 50 000 households to 500 000.</p>
</div></blockquote>
<p>Here is a minimal example of data (in CSV format):</p>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span>person_id,household_id,person_salary,person_age
1,a,2694,40
2,a,2720,43
3,b,3865,45
4,b,1300,23
5,c,0,12
6,c,0,14
7,c,2884,44
12,e,1200,38
8,d,3386,27
9,d,2929,28
10,e,0,10
11,e,1600,35
</pre></div>
</div>
<p>As for the <em>test case</em> content, you will need the following information:</p>
<ul>
<li><p>unique indentifiers for persons and <em>group entities</em></p>
<blockquote>
<div><p>like <code class="docutils literal notranslate"><span class="pre">person_id</span></code> and <code class="docutils literal notranslate"><span class="pre">household_id</span></code> columns information in the CSV example</p>
</div></blockquote>
</li>
<li><p>if you have multiple <a class="reference internal" href="../key-concepts/person%2C_entities%2C_role.html"><span class="doc std std-doc">entities</span></a> types (persons, households, …), you need to know how your persons list is dispatched over your <em>group entities</em></p>
<blockquote>
<div><p>in CSV example, every <code class="docutils literal notranslate"><span class="pre">person_id</span></code> is associated with a <code class="docutils literal notranslate"><span class="pre">household_id</span></code> on the same line</p>
</div></blockquote>
</li>
<li><p>the name of the corresponding variable in your model for every set of values</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">person_salary</span></code> values become <a class="reference external" href="https://demo.openfisca.org/legislation/salary">salary</a> values in <code class="docutils literal notranslate"><span class="pre">OpenFisca-Country-Template</span></code> model</p>
</div></blockquote>
</li>
<li><p>the period and entity for every set of values</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">person_salary</span></code> and <code class="docutils literal notranslate"><span class="pre">person_age</span></code> belong to <em>Person</em> entity
the reference period isn’t in the CSV file but it might, for example, come from the CSV creation time and be identical for the whole data set.</p>
</div></blockquote>
</li>
</ul>
<section id="application-calculate-persons-income-tax-from-a-csv-file">
<h4>Application: calculate persons income tax from a CSV file<a class="headerlink" href="#application-calculate-persons-income-tax-from-a-csv-file" title="Permalink to this headline">¶</a></h4>
<p>Let’s say you are using the <a class="reference external" href="https://github.com/openfisca/country-template">country-template</a>, which describes the legislation of a yet to be country.</p>
<p>Let’s also say you have the following <code class="docutils literal notranslate"><span class="pre">data.csv</span></code> and that you want to calculate <a class="reference external" href="https://demo.openfisca.org/legislation/income_tax">income_tax</a> for all persons:</p>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span>person_id,person_salary,person_age
1,2694,40
2,2720,43
3,3865,45
4,1300,23
5,0,12
6,0,14
7,2884,44
12,1200,38
8,3386,27
9,2929,28
10,0,10
11,1600,35
</pre></div>
</div>
<p>In the following example, we will use the <a class="reference external" href="https://pandas.pydata.org">pandas</a> library to access the data.</p>
<ol class="arabic">
<li><p>Install the required libraries, by running in your console:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>--version<span class="w"> </span><span class="c1"># Python 3.7.0 or greater should be installed on your computer</span>
pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip<span class="w"> </span>openfisca_country_template<span class="w"> </span>pandas
</pre></div>
</div>
</li>
<li><p>Load the <code class="docutils literal notranslate"><span class="pre">country-template</span></code> legislation and the content of the <code class="docutils literal notranslate"><span class="pre">data.csv</span></code> file with the <a class="reference external" href="https://pandas.pydata.org">pandas</a> library:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">openfisca_country_template</span> <span class="kn">import</span> <span class="n">CountryTaxBenefitSystem</span>

<span class="n">tax_benefit_system</span> <span class="o">=</span> <span class="n">CountryTaxBenefitSystem</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data.csv&#39;</span><span class="p">)</span>  <span class="c1"># pandas.DataFrame object</span>
<span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># ignores CSV header</span>
</pre></div>
</div>
<p>You can now access the <code class="docutils literal notranslate"><span class="pre">data.person_salary</span></code> column values and get:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">person_salary</span><span class="p">)</span>

<span class="go">0     2694</span>
<span class="go">1     2720</span>
<span class="go">2     3865</span>
<span class="go">3     1300</span>
<span class="go">4        0</span>
<span class="go">5        0</span>
<span class="go">6     2884</span>
<span class="go">7     1200</span>
<span class="go">8     3386</span>
<span class="go">9     2929</span>
<span class="go">10       0</span>
<span class="go">11    1600</span>
<span class="go">Name: person_salary, dtype: int64</span>
</pre></div>
</div>
</li>
<li><p>Build a simulation according to your data’s length with <code class="docutils literal notranslate"><span class="pre">SimulationBuilder</span></code> and configure the simulation:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openfisca_core.simulation_builder</span> <span class="kn">import</span> <span class="n">SimulationBuilder</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># ...step 2 code...</span>

<span class="n">simulation</span> <span class="o">=</span> <span class="n">SimulationBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">build_default_simulation</span><span class="p">(</span><span class="n">tax_benefit_system</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

<span class="n">period</span> <span class="o">=</span> <span class="s1">&#39;2018-01&#39;</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="s1">&#39;salary&#39;</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">person_salary</span><span class="p">))</span>
</pre></div>
</div>
</li>
</ol>
<p>You are all set! You can now calculate the <a class="reference external" href="https://demo.openfisca.org/legislation/income_tax">income_tax</a> variable for each person of your <code class="docutils literal notranslate"><span class="pre">data.csv</span></code> file for the same period:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">income_tax</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s1">&#39;income_tax&#39;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">income_tax</span></code> is an instance of <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> as you can see with:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">income_tax</span><span class="p">)</span>

<span class="go">array([404.1     408.00003      579.75    195.00002   0.        0.      432.6</span>
<span class="go">       1.        507.90002      439.35      0.      240.00002],</span>
<span class="go">      dtype=float32)</span>
</pre></div>
</div>
<p>And, persons’ order is kept:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">person_id</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="go">array([ 1  2  3  4  5  6  7 12  8  9 10 11])</span>
</pre></div>
</div>
<p>Thus, you can get the calculated <code class="docutils literal notranslate"><span class="pre">income_tax</span></code> of one person. For example, get its value for the 8th person in the list with:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">income_tax</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>  <span class="c1"># person_id == 12</span>

<span class="go">180.0</span>
</pre></div>
</div>
</section>
<section id="application-calculate-households-total-taxes-from-a-csv-file">
<h4>Application: calculate households total taxes from a CSV file<a class="headerlink" href="#application-calculate-households-total-taxes-from-a-csv-file" title="Permalink to this headline">¶</a></h4>
<p>In this example, we will manage <code class="docutils literal notranslate"><span class="pre">persons</span></code> and <code class="docutils literal notranslate"><span class="pre">households</span></code> entities. To calculate households’ <code class="docutils literal notranslate"><span class="pre">total_taxes</span></code>, we include persons’ <code class="docutils literal notranslate"><span class="pre">income_tax</span></code>. So, we need to link the persons list to the households and define their roles.</p>
<p>Let’s say that our persons and households lists are defined in distinct files:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">data_persons.csv</span></code></p>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span>person_id,household_id,person_role_in_household,person_salary,person_age
1,a,first_parent,2694,40
2,a,second_parent,2720,43
3,b,first_parent,3865,45
4,b,child,1300,23
5,c,child,0,12
6,c,child,0,14
7,c,first_parent,2884,44
12,e,second_parent,1200,38
8,d,first_parent,3386,27
9,d,second_parent,2929,28
10,e,child,0,10
11,e,unknown,1600,35
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_households.csv</span></code></p>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span>household_id,rent,accommodation_size
b,1200,64
a,700,39
d,750,31
e,840,37
c,1100,68
</pre></div>
</div>
</li>
</ul>
<p>where <code class="docutils literal notranslate"><span class="pre">household_id</span></code> is used as pivot item linking these files contents.</p>
<ol class="arabic">
<li><p>Install the required libraries, by running in your console:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>--version<span class="w"> </span><span class="c1"># Python 3.7.0 or greater should be installed on your computer</span>
pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip<span class="w"> </span>openfisca_country_template<span class="w"> </span>pandas
</pre></div>
</div>
</li>
<li><p>Load the <code class="docutils literal notranslate"><span class="pre">country-template</span></code> legislation and the content of the CSV files with the <a class="reference external" href="https://pandas.pydata.org">pandas</a> library:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">openfisca_country_template</span> <span class="kn">import</span> <span class="n">CountryTaxBenefitSystem</span>

<span class="n">tax_benefit_system</span> <span class="o">=</span> <span class="n">CountryTaxBenefitSystem</span><span class="p">()</span>

<span class="n">data_persons</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data_persons.csv&#39;</span><span class="p">)</span>
<span class="n">data_households</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data_households.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can now access the entity identifiers columns values:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">persons_ids</span> <span class="o">=</span> <span class="n">data_persons</span><span class="o">.</span><span class="n">person_id</span>
<span class="n">households_ids</span> <span class="o">=</span> <span class="n">data_households</span><span class="o">.</span><span class="n">household_id</span>
</pre></div>
</div>
</li>
<li><p>Initialise a simulation builder with the <code class="docutils literal notranslate"><span class="pre">Person</span></code> entity. All you need is the list of persons identifiers:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openfisca_core.simulation_builder</span> <span class="kn">import</span> <span class="n">SimulationBuilder</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># ...step 2 code...</span>

<span class="n">sb</span> <span class="o">=</span> <span class="n">SimulationBuilder</span><span class="p">()</span>
<span class="n">sb</span><span class="o">.</span><span class="n">create_entities</span><span class="p">(</span><span class="n">tax_benefit_system</span><span class="p">)</span>

<span class="n">persons_ids</span> <span class="o">=</span> <span class="n">data_persons</span><span class="o">.</span><span class="n">person_id</span>
<span class="n">sb</span><span class="o">.</span><span class="n">declare_person_entity</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">persons_ids</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Configure the simulation builder with your group entity <code class="docutils literal notranslate"><span class="pre">Household</span></code>. All you need here is the list of households identifiers and the role of each person member of the households:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...step 3 code...</span>

<span class="c1"># Instanciate the household entity:</span>
<span class="n">households_ids</span> <span class="o">=</span> <span class="n">data_households</span><span class="o">.</span><span class="n">household_id</span>
<span class="n">household_instance</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">declare_entity</span><span class="p">(</span><span class="s1">&#39;household&#39;</span><span class="p">,</span> <span class="n">households_ids</span><span class="p">)</span>

<span class="c1"># Join households data on persons:</span>
<span class="n">persons_households</span> <span class="o">=</span> <span class="n">data_persons</span><span class="o">.</span><span class="n">household_id</span>
<span class="n">persons_households_roles</span> <span class="o">=</span> <span class="n">data_persons</span><span class="o">.</span><span class="n">person_role_in_household</span>
<span class="n">sb</span><span class="o">.</span><span class="n">join_with_persons</span><span class="p">(</span><span class="n">household_instance</span><span class="p">,</span> <span class="n">persons_households</span><span class="p">,</span> <span class="n">persons_households_roles</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Create a simulation from the configured builder and set other inputs to your calculation like <code class="docutils literal notranslate"><span class="pre">salary</span></code> values:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">tax_benefit_system</span><span class="p">)</span>

<span class="n">period</span> <span class="o">=</span> <span class="s1">&#39;2019-03&#39;</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="s1">&#39;salary&#39;</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">data_persons</span><span class="o">.</span><span class="n">person_salary</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<p>You are all set! You can now calculate the <a class="reference external" href="https://demo.openfisca.org/legislation/total_taxes">total_taxes</a> variable for each household of your <code class="docutils literal notranslate"><span class="pre">data_households.csv</span></code> file and the same period:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">total_taxes</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s1">&#39;total_taxes&#39;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Note: This example assumes that the calculated variable and its input values share the same period.</p>
</div></blockquote>
</section>
</section>
</section>
</section>


          </div>
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="analyse-simulation.html" title="Analysing or debugging a simulation"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Running a simulation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../summary.html">OpenFisca  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><i icon-name="cog"></i> Running a simulation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to run a simulation</a></li> 
      </ul>
    </div>
  
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright . Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  <script>
    lucide.createIcons();
  </script>
  </body>
</html>